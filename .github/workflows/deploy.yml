name: ğŸš€ Build & Deploy Blog to Cloudflare

on:
    push:
        branches: [main]
        paths:
            - "docs/**"
            - "package.json"
            - "package-lock.json"
            - "vocs.config.ts"
            - "vocs.config.js"

    # Allow manual triggering
    workflow_dispatch:

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: ğŸ“¦ Install dependencies
              run: |
                  echo "ğŸ“¦ Installing dependencies..."
                  npm ci
                  echo "âœ… Dependencies installed!"

            - name: ğŸ” Check for new grant posts
              id: check-grants
              run: |
                  echo "ğŸ” Checking for new grant posts..."
                  if [ -d "docs/pages/grants" ]; then
                    GRANT_COUNT=$(find docs/pages/grants -name "*.mdx" | wc -l)
                    echo "ğŸ“Š Found $GRANT_COUNT grant posts"
                    echo "grant_count=$GRANT_COUNT" >> $GITHUB_OUTPUT
                  else
                    echo "ğŸ“ No grants directory found"
                    echo "grant_count=0" >> $GITHUB_OUTPUT
                  fi

            - name: ğŸ”„ Regenerate blog index
              run: |
                  echo "ğŸ”„ Regenerating blog index..."
                  if [ -f "docs/scripts/regenerate-index.js" ]; then
                    node docs/scripts/regenerate-index.js
                    echo "âœ… Blog index regenerated!"
                  else
                    echo "âš ï¸  No regenerate script found, skipping..."
                  fi

            - name: ğŸ“ Check Vocs config
              run: |
                  echo "ğŸ“ Checking Vocs configuration..."
                  if [ -f "vocs.config.tsx" ]; then
                    echo "âœ… Found vocs.config.tsx"
                  elif [ -f "vocs.config.js" ]; then
                    echo "âœ… Found vocs.config.js"
                  else
                    echo "âš ï¸  No vocs config found, using defaults"
                  fi

            - name: ğŸ”¨ Build Vocs project
              run: |
                  echo "ğŸ”¨ Building Vocs project..."
                  echo "ğŸ“ Current directory contents:"
                  ls -la

                  echo "ğŸ“¦ Package.json scripts:"
                  cat package.json | grep -A 10 '"scripts"'

                  echo "ğŸš€ Running build..."
                  npm run build

                  echo "âœ… Build completed!"
                  echo "ğŸ“ Dist directory contents:"
                  ls -la docs/dist/ || echo "âŒ No dist directory found"

            - name: ğŸŒ Deploy to Cloudflare Pages
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  command: pages deploy docs/dist --project-name=${{ secrets.CLOUDFLARE_PROJECT_NAME }}
                  gitHubToken: ${{ secrets.BLOG_PUBLISH_TOKEN }}

            - name: ğŸ“ Commit new blog content
              run: |
                  echo "ğŸ“ Committing new blog content..."
                  git config --local user.email "blog-publisher@voltade.com"
                  git config --local user.name "Blog Publisher Bot"

                  # Add the blog files
                  git add docs/pages/grants/
                  git add review-dashboard/public/blog_drafts/

                  # Check if there are changes to commit
                  if git diff --staged --quiet; then
                    echo "â„¹ï¸ No changes to commit"
                    exit 0
                  fi

                  # Commit the changes
                  COMMIT_MSG="ğŸ“ Add new blog post: ${{ github.event.client_payload.blog_title || 'Auto-generated blog content' }}"
                  git commit -m "$COMMIT_MSG"
                  echo "âœ… Changes committed locally"

            - name: ğŸ”„ Sync with remote before pushing
              run: |
                  echo "ğŸ”„ Syncing with remote before push..."

                  # Fetch latest remote changes
                  git fetch origin main

                  # Check if remote has new commits
                  LOCAL_COMMIT=$(git rev-parse HEAD)
                  REMOTE_COMMIT=$(git rev-parse origin/main)

                  if [ "$LOCAL_COMMIT" = "$REMOTE_COMMIT" ]; then
                    echo "âœ… No remote changes - ready to push"
                  else
                    echo "ğŸ”„ Remote has new changes - syncing..."
                    
                    # Try to rebase our commit on top of remote changes
                    if git rebase origin/main; then
                      echo "âœ… Successfully rebased local commits onto remote"
                    else
                      echo "âš ï¸ Rebase failed - trying merge strategy..."
                      git rebase --abort
                      
                      # Try merge instead
                      if git merge origin/main --no-edit; then
                        echo "âœ… Successfully merged remote changes"
                      else
                        echo "âŒ Merge failed - handling conflicts..."
                        
                        # For blog workflows, we usually want to keep both changes
                        # Check for conflicts and resolve automatically where possible
                        git status --porcelain | grep "^UU" | while read status file; do
                          echo "ğŸ”§ Auto-resolving conflict in: $file"
                          # For markdown files, we can often just accept both changes
                          git add "$file"
                        done
                        
                        # Complete the merge
                        if git diff --staged --quiet; then
                          echo "âŒ Unable to auto-resolve conflicts"
                          git merge --abort
                          echo "âš ï¸ Manual intervention required"
                          exit 1
                        else
                          git commit --no-edit -m "ğŸ”€ Merge remote changes with local blog updates"
                          echo "âœ… Conflicts resolved and merged"
                        fi
                      fi
                    fi
                  fi

            - name: ğŸš€ Push to remote with retry logic
              run: |
                  echo "ğŸš€ Pushing changes to remote..."

                  RETRY_COUNT=0
                  MAX_RETRIES=3

                  while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                    RETRY_COUNT=$((RETRY_COUNT + 1))
                    echo "ğŸ“¤ Push attempt $RETRY_COUNT of $MAX_RETRIES"
                    
                    if git push origin main; then
                      echo "âœ… Successfully pushed to remote"
                      break
                    else
                      echo "âš ï¸ Push failed (attempt $RETRY_COUNT)"
                      
                      if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                        echo "ğŸ”„ Fetching latest changes and retrying..."
                        
                        # Fetch and check for new changes
                        git fetch origin main
                        
                        # If remote moved ahead, sync again
                        if ! git merge-base --is-ancestor origin/main HEAD; then
                          echo "ğŸ”„ Remote has moved ahead - syncing again..."
                          
                          if git rebase origin/main; then
                            echo "âœ… Rebased onto latest remote changes"
                          else
                            echo "âš ï¸ Rebase failed - trying merge..."
                            git rebase --abort
                            git merge origin/main --no-edit || {
                              echo "âŒ Merge failed on retry"
                              git merge --abort
                              exit 1
                            }
                          fi
                        fi
                        
                        # Wait before retry
                        sleep $((RETRY_COUNT * 2))
                      else
                        echo "âŒ Max retries exceeded - push failed"
                        echo "ğŸ” Repository state:"
                        git status --short
                        git log --oneline -3
                        exit 1
                      fi
                    fi
                  done

            - name: âœ… Verify push success
              run: |
                  echo "âœ… Verifying push was successful..."

                  # Fetch to get latest remote state
                  git fetch origin main

                  # Compare local and remote commits
                  LOCAL_COMMIT=$(git rev-parse HEAD)
                  REMOTE_COMMIT=$(git rev-parse origin/main)

                  if [ "$LOCAL_COMMIT" = "$REMOTE_COMMIT" ]; then
                    echo "ğŸ‰ Push verification successful!"
                    echo "ğŸ“Š Blog publishing completed:"
                    echo "   Latest commit: $LOCAL_COMMIT"
                    echo "   Commit message: $(git log -1 --pretty=format:'%s')"
                    echo "   Files changed: $(git diff HEAD~1 --name-only | wc -l)"
                  else
                    echo "âŒ Push verification failed!"
                    echo "   Local:  $LOCAL_COMMIT"
                    echo "   Remote: $REMOTE_COMMIT"
                    exit 1
                  fi

            - name: ğŸ‰ Deployment success
              run: |
                  echo "ğŸ‰ Deployment completed successfully!"
                  echo "ğŸ“Š Grant posts: ${{ steps.check-grants.outputs.grant_count }}"
                  echo "ğŸŒ Your blog should be live at your Cloudflare domain!"

            - name: ğŸ“§ Notify on failure
              if: failure()
              run: |
                  echo "âŒ Deployment failed!"
                  echo "Check the logs above for more details."
