name: ğŸš€ Build & Deploy Blog to Cloudflare

on:
    push:
        branches: [main]
        paths:
            - "docs/**"
            - "package.json"
            - "package-lock.json"
            - "vocs.config.ts"
            - "vocs.config.js"

    # Allow manual triggering
    workflow_dispatch:

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: ğŸ“¦ Install dependencies
              run: |
                  echo "ğŸ“¦ Installing dependencies..."
                  npm ci
                  echo "âœ… Dependencies installed!"

            - name: ğŸ” Check for new grant posts
              id: check-grants
              run: |
                  echo "ğŸ” Checking for new grant posts..."
                  if [ -d "docs/pages/grants" ]; then
                    GRANT_COUNT=$(find docs/pages/grants -name "*.mdx" | wc -l)
                    echo "ğŸ“Š Found $GRANT_COUNT grant posts"
                    echo "grant_count=$GRANT_COUNT" >> $GITHUB_OUTPUT
                  else
                    echo "ğŸ“ No grants directory found"
                    echo "grant_count=0" >> $GITHUB_OUTPUT
                  fi

            - name: ğŸ”„ Regenerate blog index
              run: |
                  echo "ğŸ”„ Regenerating blog index..."
                  if [ -f "scripts/regenerate-index.js" ]; then
                    node docs/scripts/regenerate-index.js
                    echo "âœ… Blog index regenerated!"
                  else
                    echo "âš ï¸  No regenerate script found, skipping..."
                  fi

            - name: ğŸ“ Check Vocs config
              run: |
                  echo "ğŸ“ Checking Vocs configuration..."
                  if [ -f "vocs.config.tsx" ]; then
                    echo "âœ… Found vocs.config.tsx"
                  elif [ -f "vocs.config.js" ]; then
                    echo "âœ… Found vocs.config.js"
                  else
                    echo "âš ï¸  No vocs config found, using defaults"
                  fi

            - name: ğŸ”¨ Build Vocs project
              run: |
                  echo "ğŸ”¨ Building Vocs project..."
                  echo "ğŸ“ Current directory contents:"
                  ls -la

                  echo "ğŸ“¦ Package.json scripts:"
                  cat package.json | grep -A 10 '"scripts"'

                  echo "ğŸš€ Running build..."
                  npm run build

                  echo "âœ… Build completed!"
                  echo "ğŸ“ Dist directory contents:"
                  ls -la docs/dist/ || echo "âŒ No dist directory found"

            - name: ğŸŒ Deploy to Cloudflare Pages
              uses: cloudflare/pages-action@v1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  projectName: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
                  directory: docs/dist
                  gitHubToken: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ“ Commit updated files
              run: |
                  echo "ğŸ“ Committing any updated files..."
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action Bot"

                  # Add any auto-generated files
                  git add docs/pages/index.mdx || true
                  git add docs/pages/grants/ || true

                  # Only commit if there are changes
                  if git diff --staged --quiet; then
                    echo "ğŸ“ No changes to commit"
                  else
                    git commit -m "ğŸ¤– Auto-update blog index and grant posts"
                    git push || echo "âš ï¸  Push failed, but continuing..."
                  fi

            - name: ğŸ‰ Deployment success
              run: |
                  echo "ğŸ‰ Deployment completed successfully!"
                  echo "ğŸ“Š Grant posts: ${{ steps.check-grants.outputs.grant_count }}"
                  echo "ğŸŒ Your blog should be live at your Cloudflare domain!"

            - name: ğŸ“§ Notify on failure
              if: failure()
              run: |
                  echo "âŒ Deployment failed!"
                  echo "Check the logs above for more details."
