name: ðŸ“ Publish Blog Post

on:
    repository_dispatch:
        types: [publish-blog]

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ“¥ Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.BLOG_PUBLISH_TOKEN }}
                  fetch-depth: 0

            - name: ðŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: ðŸ“¦ Install dependencies
              run: |
                  echo "ðŸ“¦ Installing dependencies..."
                  npm ci
                  echo "âœ… Dependencies installed!"

            - name: ðŸ“ Create blog post
              run: |
                  echo "ðŸ“ Creating blog post: ${{ github.event.client_payload.filename }}"
                  echo "ðŸ“Š Content size: ${{ github.event.client_payload.content_length }} characters"

                  mkdir -p docs/pages/grants

                  # FIXED: Decode Base64 content to prevent shell execution
                  echo "${{ github.event.client_payload.content_base64 }}" | base64 -d > "docs/pages/grants/${{ github.event.client_payload.filename }}"

                  # Verify file was created successfully
                  if [ -f "docs/pages/grants/${{ github.event.client_payload.filename }}" ]; then
                    FILE_SIZE=$(wc -c < "docs/pages/grants/${{ github.event.client_payload.filename }}")
                    echo "âœ… Blog post created successfully!"
                    echo "ðŸ“„ File: docs/pages/grants/${{ github.event.client_payload.filename }}"
                    echo "ðŸ“Š File size: $FILE_SIZE bytes"
                    
                    # Show first few lines to verify content
                    echo "ðŸ” Content preview:"
                    head -n 5 "docs/pages/grants/${{ github.event.client_payload.filename }}"
                  else
                    echo "âŒ Failed to create blog post file!"
                    exit 1
                  fi

            - name: ðŸ”„ Regenerate blog index
              run: |
                  echo "ðŸ”„ Regenerating blog index..."
                  if [ -f "docs/scripts/regenerate-index.js" ]; then
                    node docs/scripts/regenerate-index.js
                    echo "âœ… Blog index regenerated!"
                  else
                    echo "âš ï¸  No regenerate script found, skipping..."
                  fi

            - name: ðŸš€ Commit and push changes
              run: |
                  git config --local user.email "blog-publisher@voltade.com"
                  git config --local user.name "Blog Publisher Bot"

                  # Add the new files
                  git add docs/pages/grants/${{ github.event.client_payload.filename }}
                  git add docs/pages/index.mdx || true

                  # Check if there are changes to commit
                  if git diff --staged --quiet; then
                    echo "âš ï¸ No changes to commit"
                  else
                    # Commit the changes
                    git commit -m "${{ github.event.client_payload.message }}"
                    git push
                    echo "âœ… Blog post committed and pushed!"
                    
                    # Show commit info
                    echo "ðŸ“Š Commit details:"
                    git log -1 --oneline
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.BLOG_PUBLISH_TOKEN }}

            - name: ðŸŽ‰ Publication success
              run: |
                  echo "ðŸŽ‰ Blog post published successfully!"
                  echo "ðŸ“„ File: ${{ github.event.client_payload.filename }}"
                  echo "ðŸ“ Path: docs/pages/grants/${{ github.event.client_payload.filename }}"
                  echo "â° Published at: ${{ github.event.client_payload.timestamp }}"
                  echo "ðŸš€ Your existing deployment workflow will now trigger automatically!"
