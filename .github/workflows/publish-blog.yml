name: ğŸ“ Publish Blog Post

on:
    repository_dispatch:
        types: [publish-blog]

jobs:
    publish:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: ğŸ“¦ Install dependencies
              run: |
                  echo "ğŸ“¦ Installing dependencies..."
                  npm ci
                  echo "âœ… Dependencies installed!"

            - name: ğŸ“ Create blog post
              run: |
                  echo "ğŸ“ Creating blog post: ${{ github.event.client_payload.filename }}"
                  mkdir -p docs/pages/grants
                  echo "${{ github.event.client_payload.content }}" > "docs/pages/grants/${{ github.event.client_payload.filename }}"
                  echo "âœ… Blog post created!"

            - name: ğŸ”„ Regenerate blog index
              run: |
                  echo "ğŸ”„ Regenerating blog index..."
                  if [ -f "docs/scripts/regenerate-index.js" ]; then
                    node docs/scripts/regenerate-index.js
                    echo "âœ… Blog index regenerated!"
                  else
                    echo "âš ï¸  No regenerate script found, skipping..."
                  fi

            - name: ğŸš€ Commit and push changes
              run: |
                  git config --local user.email "blog-publisher@voltade.com"
                  git config --local user.name "Blog Publisher Bot"

                  # Add the new files
                  git add docs/pages/grants/${{ github.event.client_payload.filename }}
                  git add docs/pages/index.mdx || true

                  # Commit the changes
                  git commit -m "${{ github.event.client_payload.message }}"
                  git push

                  echo "âœ… Blog post committed and pushed!"
              env:
                  GITHUB_TOKEN: ${{ secrets.voltade-blog-push-access }}

            - name: ğŸ‰ Publication success
              run: |
                  echo "ğŸ‰ Blog post published successfully!"
                  echo "ğŸ“„ File: ${{ github.event.client_payload.filename }}"
                  echo "ğŸš€ Your existing deployment workflow will now trigger automatically!"
